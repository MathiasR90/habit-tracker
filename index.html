<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ma Cha√Æne ‚Äî Habitudes Quotidiennes et Mensuelles</title>

<!-- PWA -->
  <meta name="theme-color" content="#2B6BE3">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-180.png">

<style>
:root {
  --bg: #F7F7F7;
  --card: #FFFFFF;
  --text: #111111;
  --muted: #666666;
  --border: #E6E6E6;
  --ok: #2ECC71;
  --fail: #E74C3C;
  --future: #DADADA;
  --accent: #2B6BE3;
}
@media (prefers-color-scheme: dark) {
  :root { --bg:#1A1A1A; --card:#101010; --text:#EDEDED; --muted:#A8A8A8; --border:#2A2A2A; --future:#3A3A3A; }
}
body {margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text);} 
.app {max-width:780px; margin:auto; padding:16px 16px 112px;} 
header {margin-bottom:8px;}
.card {background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; margin:12px 0;} 
.habit-head {display:flex; justify-content:space-between; align-items:center; font-weight:600;} 
.section {margin: 12px 0 20px;}
.section h2 {font-size: 1.1rem; margin: 6px 0 4px; opacity:.9}
.row {display:flex; gap:8px; overflow-x:auto; padding:8px 0; scroll-behavior:auto; overscroll-behavior:contain;} 
.cell {width:50px; height:36px; border-radius:6px; background:var(--future); border:1px solid var(--border); display:grid; place-items:center; transition:background-color .2s, transform .08s; font-size:14px; cursor:pointer;} 
.cell.ok {background:var(--ok); border-color:transparent;} 
.cell.fail {background:var(--fail); border-color:transparent;} 
.cell.locked {opacity:.5; cursor:default;} 
.legend {display:flex; gap:8px; font-size:12px; color:var(--muted); margin-top:6px;} 
.dot {width:10px; height:10px; border-radius:3px; display:inline-block;} 
.dot.ok {background:var(--ok);} .dot.fail {background:var(--fail);} .dot.future {background:var(--future);} 

/* Controls (bas de page) */
.controls {position:fixed; bottom:0; left:0; right:0; display:grid; grid-template-columns:1fr auto auto; gap:8px; padding:12px; background:var(--bg); border-top:1px solid var(--border);}  
.input {padding:12px; border-radius:12px; border:1px solid var(--border); font-size:16px;}
.select {padding:12px; border-radius:12px; border:1px solid var(--border); font-size:16px; background:var(--card);} 
.btn {padding:12px 16px; border-radius:12px; background:var(--accent); color:#fff; border:none; font-weight:600; cursor:pointer;}
/* Couleurs demand√©es */
#habitType { background-color:#e0e0e0; color:#333; }
#addBtn { background-color:orange; color:#fff; }

/* Delete button + modal */
.btn-icon{background:transparent;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:6px 8px;border-radius:8px;line-height:1}
.btn-icon.danger{color:var(--fail)}
.btn-icon:active{transform:scale(0.96)}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:9999}
.modal{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:16px;max-width:340px;width:calc(100% - 32px);box-shadow:0 10px 30px rgba(0,0,0,.2)}
.modal h3{margin:0 0 6px;font-size:16px}
.modal p{margin:0 0 12px;color:var(--muted);font-size:14px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end}
.modal .actions button{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)}
.modal .actions .danger{background:var(--fail);border-color:transparent;color:#fff}

/* Day/Month labels */
.day-label {text-align:center; font-size:12px; margin-bottom:4px; font-weight:300;}
.day-label.today {font-weight:900;}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Suivi d'habitudes <span id="todayStr"></span></h1>
    <div id="summary">0/0 quotidiennes faites aujourd'hui</div>
  </header>

  <div class="section" id="daily-section">
    <h2>Quotidiennes</h2>
    <div id="daily-list"></div>
  </div>

  <div class="section" id="monthly-section">
    <h2>Mensuelles</h2>
    <div id="monthly-list"></div>
  </div>

  <div class="legend">
    <span class="dot ok"></span> Valid√©
    <span class="dot fail"></span> Rat√©
    <span class="dot future"></span> √Ä faire
  </div>
</div>

<!-- Controls -->
<div class="controls">
  <input id="habitInput" class="input" placeholder="Nouvelle habitude" />
  <select id="habitType" class="select">
    <option value="daily">Quotidienne</option>
    <option value="monthly">Mensuelle</option>
  </select>
  <button id="addBtn" class="btn">Ajouter</button>
</div>

<script>
// ===== Config & State =====
const STORAGE_KEY = 'habits_v3';
const FUTURE_DAYS = 2;   // daily futurs verrouill√©s
const PAST_DAYS = 6;     // daily pass√©s modifiables
const FUTURE_MONTHS = 2; // monthly futurs verrouill√©s
const PAST_MONTHS = 6;   // monthly pass√©s modifiables
const LONG_PRESS_RESET = 500; // ms

const today = new Date(); today.setHours(0,0,0,0);
const month0 = new Date(today.getFullYear(), today.getMonth(), 1); // d√©but du mois courant
const todayKey = toDayKey(today);

// ===== Utils =====
function toDayKey(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
function toMonthKey(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}
function formatDate(d){return d.toLocaleDateString('fr-FR',{weekday:'short',day:'2-digit',month:'short'});} 
function load(){return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');}
function save(habits){localStorage.setItem(STORAGE_KEY,JSON.stringify(habits));}
function cryptoId(){return Math.random().toString(36).slice(2)+Date.now().toString(36);}  
function daysSpan(){const arr=[];for(let i=-PAST_DAYS;i<=FUTURE_DAYS;i++){const d=new Date(today);d.setDate(today.getDate()+i);d.setHours(0,0,0,0);arr.push(d);}return arr;}
function monthsSpan(){const arr=[];for(let i=-PAST_MONTHS;i<=FUTURE_MONTHS;i++){const d=new Date(month0);d.setMonth(month0.getMonth()+i);d.setDate(1);d.setHours(0,0,0,0);arr.push(d);}return arr;}
function computeStreakDaily(h){let s=0;let cur=new Date(today);while(h.records[toDayKey(cur)]==='ok'){s++;cur.setDate(cur.getDate()-1);}return s;}
function computeStreakMonthly(h){let s=0;let cur=new Date(month0);while(h.records[toMonthKey(cur)]==='ok'){s++;cur.setMonth(cur.getMonth()-1);}return s;}
function nudge(el){ el.style.transform='scale(0.96)'; setTimeout(()=>{ el.style.transform='scale(1)'; }, 100); }

function getState(h,id,key){ return (h && h.records) ? h.records[key] : undefined; }
function setStateById(id,key,state){ const all=load(); const h=all.find(x=>x.id===id); if(!h) return; if(state===undefined) delete h.records[key]; else h.records[key]=state; save(all); }

// ===== Renderers =====
function render(){
  const habits = load();
  const dailyList = document.getElementById('daily-list');
  const monthlyList = document.getElementById('monthly-list');
  dailyList.innerHTML = '';
  monthlyList.innerHTML = '';

  const daily = habits.filter(h=>h.type==='daily');
  const monthly = habits.filter(h=>h.type==='monthly');

  daily.forEach(h=> dailyList.appendChild(renderHabitCard(h, 'daily')));
  monthly.forEach(h=> monthlyList.appendChild(renderHabitCard(h, 'monthly')));

  updateSummary(habits);
}

function renderHabitCard(habit, kind){
  const card=document.createElement('div');card.className='card';
  const head=document.createElement('div');head.className='habit-head';

  const left=document.createElement('div');
  left.textContent=habit.name;

  const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
  const streak=document.createElement('div'); streak.textContent = `üî• ${kind==='daily'?computeStreakDaily(habit):computeStreakMonthly(habit)}`;
  const del=document.createElement('button'); del.type='button'; del.className='btn-icon danger'; del.textContent='‚úñÔ∏è'; del.addEventListener('click',()=>requestDelete(habit.id, habit.name));
  right.appendChild(streak); right.appendChild(del);

  head.appendChild(left); head.appendChild(right);
  card.appendChild(head);

  const row=document.createElement('div'); row.className='row';
  const span = kind==='daily' ? daysSpan() : monthsSpan();
  span.forEach(d=>{
    const key = (kind==='daily') ? toDayKey(d) : toMonthKey(d);
    const state = habit.records[key];
    const isFuture = (kind==='daily') ? (d>today) : (d>month0);
    const isTodayLike = (kind==='daily') ? (toDayKey(d)===todayKey) : (toMonthKey(d)===toMonthKey(month0));

    const wrap=document.createElement('div');
    const label=document.createElement('div');
    if(kind==='daily'){
      label.textContent=d.toLocaleDateString('fr-FR',{weekday:'narrow'});
    } else {
      label.textContent=d.toLocaleDateString('fr-FR',{month:'short'}).charAt(0).toUpperCase();
    }
    label.className='day-label' + (isTodayLike?' today':'');
    wrap.appendChild(label);

    const cell=document.createElement('div'); cell.className='cell';
    if(state==='ok') cell.classList.add('ok');
    else if(state==='fail') cell.classList.add('fail');
    else cell.classList.add('future');
    if(isFuture) cell.classList.add('locked');

    if(!isFuture){
      let pressTimer=null; let clickTimer=null;
      const clearPress=()=>{ if(pressTimer) clearTimeout(pressTimer); pressTimer=null; };
      const clearClick=()=>{ if(clickTimer) clearTimeout(clickTimer); clickTimer=null; };
      // click -> ok if empty
      cell.addEventListener('click',(e)=>{
        if(e.detail>1) return; // let dblclick win
        clearClick();
        clickTimer=setTimeout(()=>{
          if(getState(habit,habit.id,key)!==undefined){ nudge(cell); return; }
          setStateById(habit.id,key,'ok');
          render();
        }, 250);
      });
      // dblclick -> fail if empty
      cell.addEventListener('dblclick',()=>{
        clearClick();
        if(getState(habit,habit.id,key)!==undefined){ nudge(cell); return; }
        setStateById(habit.id,key,'fail');
        render();
      });
      // long press -> reset always
      cell.addEventListener('mousedown',()=>{ pressTimer=setTimeout(()=>{ clearClick(); setStateById(habit.id,key,undefined); render(); }, LONG_PRESS_RESET); });
      cell.addEventListener('mouseup',clearPress);
      cell.addEventListener('mouseleave',clearPress);
      cell.addEventListener('touchstart',()=>{ pressTimer=setTimeout(()=>{ clearClick(); setStateById(habit.id,key,undefined); render(); }, LONG_PRESS_RESET); }, {passive:true});
      cell.addEventListener('touchend',clearPress,{passive:true});
    }

    wrap.appendChild(cell);
    row.appendChild(wrap);
  });
  // scroll √† droite par d√©faut
  row.scrollLeft = row.scrollWidth;

  card.appendChild(row);
  return card;
}

function updateSummary(habits){
  const doneDaily = habits.filter(h=>h.type==='daily').reduce((a,h)=> a + (h.records[todayKey]==='ok'?1:0), 0);
  const totalDaily = habits.filter(h=>h.type==='daily').length;
  document.getElementById('summary').textContent = `${doneDaily}/${totalDaily} quotidiennes faites aujourd'hui`;
  document.getElementById('todayStr').textContent=`‚Äî ${formatDate(today)}`;
}

// ===== Delete flow =====
function requestDelete(id, name){
  const overlay=document.createElement('div');
  overlay.className='modal-backdrop';
  overlay.innerHTML=`<div class="modal">
    <h3>Supprimer l'habitude ?</h3>
    <p>"${(name||'Cette habitude').replace(/"/g,'\\"')}" sera supprim√©e.</p>
    <div class="actions">
      <button type="button" data-act="cancel">Annuler</button>
      <button type="button" class="danger" data-act="confirm">Supprimer</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
  const cancelBtn = overlay.querySelector('[data-act="cancel"]');
  const confirmBtn = overlay.querySelector('[data-act="confirm"]');
  cancelBtn.addEventListener('click',()=>{ document.body.removeChild(overlay); });
  confirmBtn.addEventListener('click',()=>{ deleteHabit(id); document.body.removeChild(overlay); });
  overlay.addEventListener('click',(e)=>{ if(e.target===overlay){ document.body.removeChild(overlay); } });
}
function deleteHabit(id){
  const habits=load().filter(h=>h.id!==id);
  save(habits);
  render();
}

// ===== Add habit =====
function addHabit(name, type){
  const habits=load();
  habits.push({ id: cryptoId(), name, type, records:{} });
  save(habits);
  render();
}

// ===== Wire UI =====
document.getElementById('addBtn').onclick = () => {
  const input = document.getElementById('habitInput');
  const type = document.getElementById('habitType').value;
  const name = input.value.trim();
  if(!name) return;
  addHabit(name, type);
  input.value='';
};

document.getElementById('habitInput').addEventListener('keydown',e=>{ if(e.key==='Enter') document.getElementById('addBtn').click(); });

// initial render
function init(){ document.getElementById('todayStr').textContent=`‚Äî ${formatDate(today)}`; render(); }
init();
</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function () {
      navigator.serviceWorker.register('./service-worker.js').catch(() => {});
    });
  }
</script>
</body>
</html>
